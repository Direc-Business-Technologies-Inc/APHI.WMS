@using Web.BlazorServer.Components.Security
@using Web.BlazorServer.Components.Shared.Skeletons
@using Web.BlazorServer.ViewModels.Transaction.GoodsReturn

@inherits BaseForm<GoodsReturnRequestVM>
@page "/transactions/purchasing/goods-return/request/create"
@page "/transactions/purchasing/goods-return/request/view"
@layout ProtectedLayout
@attribute [AppAuthorizationAttribute("VIEW", "OGRN")]

<PageTitle>@(Creating ? "New Goods Return Document" : string.Empty)@(Viewing ? $"Goods Return {FormData.SapReference.DocNum}" : string.Empty)</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
    <AppBreadCrumbs ModuleCode="OGRN" />
</RadzenStack>
<AppContent>
    <AppFormSkeleton TItem="GoodsReturnRequestVM" Loading="@IsLoadingData" />
    <RadzenStack Visible="@(!IsLoadingData)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="32px" class="rz-mb-2">
        <RadzenStack Visible="@Viewing" Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"Doc. Ref. No.")" class="rz-m-0" />
            <RadzenText Text="@($"PO# {FormData.SapReference.DocNum.ToString()}")" class="rz-m-0" />
        </RadzenStack>
        <RadzenStack Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"PO Doc. Date")" class="rz-m-0" />
            <RadzenText Text="@FormData.DocDate.ToString("MMM dd, yyyy")" class="rz-m-0" />
        </RadzenStack>
        <RadzenStack Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"Doc. Due Date")" class="rz-m-0" />
            <RadzenText Text="@FormData.DocDueDate.ToString("MMM dd, yyyy")" class="rz-m-0" />
        </RadzenStack>
    </RadzenStack>
    <RadzenTemplateForm Visible="@(!IsLoadingData)" @ref="@TemplateForm" TItem="GoodsReturnRequestVM" @bind-Data="@FormData" EditContext="@EditContext" Submit="@HandleSubmit">
        <RadzenStack Gap="2rem">
            <RadzenFieldset AllowCollapse Text="Details">
                <ChildContent>
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Vendor Ref No." class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Value="@FormData.BusinessPartner.CardCode" Name="gr_card_code" Disabled="@IsBusy" class="rz-w-100" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Supplier Name" class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Value="@FormData.BusinessPartner.CardName" Placeholder="N/A" Name="gr_card_name" Disabled="@IsBusy" class="rz-w-100" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </ChildContent>
            </RadzenFieldset>
            <RadzenFieldset AllowCollapse Text="Details">
                <ChildContent>
                    <RadzenRow>
                        <RadzenColumn>
                            <AppTable @ref="@GoodsReturnTable" TItem="GRRLineVM" @bind-GridSettingsLoaded="@GridSettingsLoaded" Data="@FormData.DocumentLines">
                                <Columns>
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.LineNum)"
                                                          Width="40px" TextAlign="TextAlign.Center" />
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.ItemCode)"
                                                          Title="Item Code" />
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.ItemName)"
                                                          Title="Item Name" />
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.Warehouse.WhsName)"
                                                          Title="Warehouse" Width="150px">
                                        <Template Context="data">
                                            @data.Warehouse.WhsName
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.UoMName)"
                                                          Title="UoM" Width="125px" />
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.TargetQty)"
                                                          Title="Target Qty" Width="150px">
                                        <Template Context="data">
                                            <RadzenNumeric Format="N0" @bind-Value="@data.TargetQty" Min="0" ReadOnly ShowUpDown="false" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.OpenQty)"
                                                          Title="Open Qty" Width="150px">
                                        <Template Context="data">
                                            <RadzenNumeric Format="N0" @bind-Value="@data.OpenQty" Min="0" ReadOnly ShowUpDown="false" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="GRRLineVM"
                                                          Property="@nameof(GRRLineVM.Quantity)"
                                                          Title="Quantity" Width="150px">
                                        <Template Context="data">
                                            <RadzenNumeric Format="N0" @bind-Value="@data.Quantity" Min="0" ReadOnly="@Viewing" ShowUpDown="@Creating" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </AppTable>
                        </RadzenColumn>
                    </RadzenRow>
                </ChildContent>
            </RadzenFieldset>
            <RadzenRow>
                <RadzenColumn>
                    <RadzenStack class="rz-mt-8" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenButton IsBusy="@IsBusy" Text="Back" Disabled="@(IsBusy && Creating)" ButtonStyle="ButtonStyle.Base" Click="@Return" />
                        <RadzenButton IsBusy="@IsBusy" Text="Edit" Disabled="@(IsBusy)" Visible="@Viewing" ButtonStyle="ButtonStyle.Base" Click="@InitializeEditing" />
                        <RadzenStack Visible="@(Can.Create("OGRN") && Creating)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="16px">
                            <RadzenButton IsBusy="@IsBusy" ButtonStyle="ButtonStyle.Base" Click="@CancelEditing">
                                Cancel
                            </RadzenButton>
                            <RadzenButton IsBusy="@IsBusy" Visible="@(Creating)" ButtonStyle="ButtonStyle.Success" ButtonType="ButtonType.Submit">
                                Save
                            </RadzenButton>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenTemplateForm>
</AppContent>