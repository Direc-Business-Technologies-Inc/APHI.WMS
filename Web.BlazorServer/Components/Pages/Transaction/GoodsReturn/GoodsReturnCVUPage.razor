@using Web.BlazorServer.Components.Pages.Transaction.GoodsReturn.Components
@using Web.BlazorServer.Components.Security
@using Web.BlazorServer.Components.Shared.Skeletons
@using Web.BlazorServer.Extensions
@using Web.BlazorServer.ViewModels.Others
@using Web.BlazorServer.ViewModels.Transaction.GoodsReturn

@inherits BaseForm<GoodsReturnVM>
@page "/transactions/purchasing/goods-return/create"
@page "/transactions/purchasing/goods-return/view"
@layout ProtectedLayout
@attribute [AppAuthorizationAttribute("VIEW", "OGRN")]

<PageTitle>@(Creating ? "New Goods Return Document" : string.Empty)@(Viewing ? $"Goods Return {FormData.SapReference.DocNum}" : string.Empty)</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
    <AppBreadCrumbs ModuleCode="OGRN" />
</RadzenStack>
<AppContent>
    <AppFormSkeleton TItem="GoodsReturnVM" Loading="@IsLoadingData" />
    <RadzenStack Visible="@(!IsLoadingData)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="32px" class="rz-mb-2">
        <RadzenStack Visible="@Viewing" Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"Doc. Ref. No.")" class="rz-m-0" />
            <RadzenText Text="@($"PO# {FormData.SapReference.DocNum.ToString()}")" class="rz-m-0" />
        </RadzenStack>
        <RadzenStack Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"PO Doc. Date")" class="rz-m-0" />
            <RadzenText Text="@FormData.DocDate.ToString("MMM dd, yyyy")" class="rz-m-0" />
        </RadzenStack>
        <RadzenStack Gap="0px">
            <RadzenText TextStyle="TextStyle.Subtitle2" Text="@($"Doc. Due Date")" class="rz-m-0" />
            <RadzenText Text="@FormData.DocDueDate.ToString("MMM dd, yyyy")" class="rz-m-0" />
        </RadzenStack>
    </RadzenStack>
    <RadzenTemplateForm Visible="@(!IsLoadingData)" @ref="@TemplateForm" TItem="GoodsReturnVM" @bind-Data="@FormData" EditContext="@EditContext" Submit="@HandleSubmit">
        <RadzenStack Gap="2rem">
            <RadzenFieldset AllowCollapse Text="Details">
                <ChildContent>
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Vendor Ref No." class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Visible="@Viewing" Value="@FormData.BusinessPartner.CardCode" Name="gr_card_code" Disabled="@IsBusy" class="rz-w-100" />
                                    <RadzenDropDown Visible="@(Creating)"
                                                    @bind-Value="@FormData.BusinessPartner"
                                                    Change="(args) => OnFieldChanged(nameof(FormData.BusinessPartner))"
                                                    Data="@BusinessPartners"
                                                    Count="@BusinessPartnersCount"
                                                    LoadData="@LoadVendors"
                                                    AllowVirtualization
                                                    Name="gr_bp"
                                                    AllowFiltering
                                                    TextProperty="@nameof(BusinessPartnerVM.CardName)"
                                                    Placeholder="No Vendor Selected"
                                                    class="rz-w-100" />
                                </ChildContent>
                                <Helper>
                                    <RadzenCustomValidator Visible="@(Creating)" Component="gr_bp" Popup Validator="@FormData.ValidateBusinessPartner" Text="Vendor is required" />
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Supplier Name" class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Value="@FormData.BusinessPartner.CardName" Placeholder="N/A" Name="gr_card_name" Disabled="@IsBusy" class="rz-w-100" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow class="rz-mt-4">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Warehouse" class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Visible="@Viewing" Value="@FormData.Warehouse.WhsName" Name="gr_whs_name" Disabled="@IsBusy" class="rz-w-100" />
                                    <RadzenDropDown Visible="@(Creating)"
                                                    @bind-Value="@FormData.Warehouse"
                                                    Change="(args) => OnFieldChanged(nameof(FormData.Warehouse))"
                                                    Data="@Warehouses"
                                                    Count="@WarehousesCount"
                                                    LoadData="@LoadWarehouses"
                                                    AllowVirtualization
                                                    Name="gr_whs"
                                                    AllowFiltering
                                                    TextProperty="@nameof(WarehouseVM.WhsName)"
                                                    Placeholder="No Vendor Selected"
                                                    class="rz-w-100" />
                                </ChildContent>
                                <Helper>
                                    <RadzenCustomValidator Visible="@(Creating)" Component="gr_whs" Popup Validator="@FormData.ValidateWarehouse" Text="Source Warehouse is required" />
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Warehouse" class="rz-w-100">
                                <ChildContent>
                                    <RadzenTextBox ReadOnly Value="@FormData.PreparedBy" Name="gr_prep_by" Disabled="@IsBusy" class="rz-w-100" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </ChildContent>
            </RadzenFieldset>
            <RadzenFieldset AllowCollapse Text="Details">
                <ChildContent>
                    <RadzenRow>
                        <RadzenColumn>
                            <AppTable @ref="@GoodsReturnTable" TItem="GoodsReturnLineVM" @bind-GridSettingsLoaded="@GridSettingsLoaded" Data="@FormData.DocumentLines">
                                <HeaderTemplate>
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" AlignItems="AlignItems.Center" Gap="8px">
                                        <RadzenButton Icon="add" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Click="@AddItems" Disabled="@(string.IsNullOrEmpty(FormData.Warehouse.WhsCode))" />
                                    </RadzenStack>
                                </HeaderTemplate>
                                <Columns>
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.LineNum)"
                                                          Width="40px" TextAlign="TextAlign.Center" />
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.ItemCode)"
                                                          Title="Item Code" />
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.ItemName)"
                                                          Title="Item Name" />
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.Warehouse.WhsName)"
                                                          Title="Warehouse" Width="150px">
                                        <Template Context="data">
                                            @data.Warehouse.WhsName
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.UoMName)"
                                                          Title="UoM" Width="125px" />
                                    <RadzenDataGridColumn TItem="GoodsReturnLineVM"
                                                          Property="@nameof(GoodsReturnLineVM.Quantity)"
                                                          Title="Quantity" Width="150px">
                                        <Template Context="data">
                                            <RadzenNumeric Format="N0" @bind-Value="@data.Quantity" Min="0" ReadOnly="@Viewing" ShowUpDown="@Creating" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </AppTable>
                        </RadzenColumn>
                    </RadzenRow>
                </ChildContent>
            </RadzenFieldset>
            <RadzenRow>
                <RadzenColumn>
                    <RadzenStack class="rz-mt-8" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenButton IsBusy="@IsBusy" Text="Back" Disabled="@(IsBusy && Creating)" ButtonStyle="ButtonStyle.Base" Click="@Return" />
                        <RadzenStack Visible="@(Can.Create("OGRN") && Creating)" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="16px">
                            <RadzenButton IsBusy="@IsBusy" Visible="@(Creating)" ButtonStyle="ButtonStyle.Success" ButtonType="ButtonType.Submit">
                                Save
                            </RadzenButton>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenTemplateForm>
</AppContent>

@code {
    async Task AddItems()
    {
        await DialogService.OpenAsync(
            "Table Settings",
            ds => @<GoodsReturnItemSelection @bind-Return="@FormData" />,
            options: GridSettingsService.GetDialogOptions().MaximizedMode());

        await GoodsReturnTable.DataGrid.Reload();
    }
}